namespace Kantar.StudyDesignerLite.PluginsAuxiliar.Repositories.ManagedList
{
    using System;
    using System.Collections.Generic;
    using System.Diagnostics.CodeAnalysis;
    using System.Linq;
    using Kantar.StudyDesignerLite.Plugins;
    using Microsoft.Xrm.Sdk;
    using Microsoft.Xrm.Sdk.Query;

    [ExcludeFromCodeCoverage]
    public class ManagedListRepository : IManagedListRepository
    {
        private readonly IOrganizationService _service;

        public ManagedListRepository(IOrganizationService service)
        {
            _service = service ?? throw new ArgumentNullException(nameof(service));
        }

        public IEnumerable<KTR_ManagedList> GetStudyManagedLists(Guid studyId)
        {
            var query = new QueryExpression
            {
                EntityName = KTR_ManagedList.EntityLogicalName,
                ColumnSet = new ColumnSet(
                    KTR_ManagedList.Fields.Id,
                    KTR_ManagedList.Fields.KTR_Name,
                    KTR_ManagedList.Fields.KTR_Description,
                    KTR_ManagedList.Fields.KTR_IsAutoGenerated,
                    KTR_ManagedList.Fields.KTR_SourceType)
            };

            var managedListEntityLink = query.AddLink(
                KTR_ManagedListEntity.EntityLogicalName,
                KTR_ManagedList.Fields.Id,
                KTR_ManagedListEntity.Fields.KTR_ManagedList
            );
            managedListEntityLink.JoinOperator = JoinOperator.Inner;

            var studyManagedListEntityLink = managedListEntityLink.AddLink(
                KTR_StudyManagedListEntity.EntityLogicalName,
                KTR_ManagedListEntity.Fields.Id,
                KTR_StudyManagedListEntity.Fields.KTR_ManagedListEntity
            );
            studyManagedListEntityLink.JoinOperator = JoinOperator.Inner;
            studyManagedListEntityLink.LinkCriteria.AddCondition(
                KTR_StudyManagedListEntity.Fields.KTR_Study,
                ConditionOperator.Equal,
                studyId
            );

            managedListEntityLink.LinkCriteria.AddCondition(
                KTR_StudyManagedListEntity.Fields.StateCode,
                ConditionOperator.Equal,
                (int)KTR_StudyManagedListEntity_StateCode.Active
            );

            var results = _service.RetrieveMultiple(query);
            return results.Entities.Select(e => e.ToEntity<KTR_ManagedList>()).ToList();
        }

        public IDictionary<Guid, IList<KTR_ManagedListEntity>> GetStudyManagedListsWithEntities(Guid studyId)
        {
            var result = new Dictionary<Guid, IList<KTR_ManagedListEntity>>();

            var query = new QueryExpression
            {
                EntityName = KTR_ManagedListEntity.EntityLogicalName,
                ColumnSet = new ColumnSet(true)
            };

            var studyManagedListEntityLink = query.AddLink(
                KTR_StudyManagedListEntity.EntityLogicalName,
                KTR_ManagedListEntity.Fields.Id,
                KTR_StudyManagedListEntity.Fields.KTR_ManagedListEntity
            );
            studyManagedListEntityLink.JoinOperator = JoinOperator.Inner;

            studyManagedListEntityLink.LinkCriteria.AddCondition(
                KTR_StudyManagedListEntity.Fields.KTR_Study,
                ConditionOperator.Equal,
                studyId
            );
            studyManagedListEntityLink.LinkCriteria.AddCondition(
                KTR_StudyManagedListEntity.Fields.StateCode,
                ConditionOperator.Equal,
                (int)KTR_StudyManagedListEntity_StateCode.Active
            );

            query.Criteria.AddCondition(
                KTR_ManagedListEntity.Fields.StateCode,
                ConditionOperator.Equal,
                (int)KTR_ManagedListEntity_StateCode.Active
            );

            query.Orders.Add(new OrderExpression(
                KTR_ManagedListEntity.Fields.KTR_DisplayOrder,
                OrderType.Ascending
            ));

            var results = _service.RetrieveMultiple(query);

            foreach (var entity in results.Entities)
            {
                var managedListEntity = entity.ToEntity<KTR_ManagedListEntity>();
                var managedListId = managedListEntity.KTR_ManagedList?.Id;

                if (managedListId.HasValue)
                {
                    if (!result.ContainsKey(managedListId.Value))
                    {
                        result[managedListId.Value] = new List<KTR_ManagedListEntity>();
                    }
                    result[managedListId.Value].Add(managedListEntity);
                }
            }

            return result;
        }

        public IEnumerable<KTR_ManagedList> GetManagedListsByIds(IEnumerable<Guid> managedListIds)
        {
            if (managedListIds?.Any() != true)
            {
                return new List<KTR_ManagedList>();
            }

            var query = new QueryExpression
            {
                EntityName = KTR_ManagedList.EntityLogicalName,
                ColumnSet = new ColumnSet(
                    KTR_ManagedList.Fields.Id,
                    KTR_ManagedList.Fields.KTR_Name,
                    KTR_ManagedList.Fields.KTR_Description,
                    KTR_ManagedList.Fields.KTR_IsAutoGenerated,
                    KTR_ManagedList.Fields.KTR_SourceType),
                Criteria = new FilterExpression
                {
                    Conditions = 
                    {
                        new ConditionExpression(KTR_ManagedList.Fields.Id, ConditionOperator.In, managedListIds.ToArray())
                    }
                }
            };

            var results = _service.RetrieveMultiple(query);
            return results.Entities.Select(e => e.ToEntity<KTR_ManagedList>()).ToList();
        }

        public List<KTR_ManagedList> GetManagedListsByLocation(IOrganizationService service, Guid questionnaireLineId, KTR_Location location)
        {
            var columns = new ColumnSet
            {
                AllColumns = true
            };

            var query = new QueryExpression(KTR_ManagedList.EntityLogicalName)
            {
                ColumnSet = columns,
                Criteria =
                {
                    Conditions =
                    {
                        new ConditionExpression(KTR_ManagedList.Fields.StatusCode, ConditionOperator.Equal, (int)KTR_ManagedList_StatusCode.Active)
                    }
                }
            };

            query.AddLink(
                KTR_QuestionnaireLinesHaRedList.EntityLogicalName,
                KTR_ManagedList.Fields.KTR_ManagedListId,
                KTR_QuestionnaireLinesHaRedList.Fields.KTR_ManagedList,
                JoinOperator.Inner)
                .LinkCriteria.Conditions.AddRange(new[]
                {
                    new ConditionExpression(KTR_QuestionnaireLinesHaRedList.Fields.KTR_QuestionnaireLine, ConditionOperator.Equal, questionnaireLineId),
                    new ConditionExpression(KTR_QuestionnaireLinesHaRedList.Fields.StatusCode, ConditionOperator.Equal, (int)KTR_QuestionnaireLinesHaRedList_StatusCode.Active),
                    new ConditionExpression(KTR_QuestionnaireLinesHaRedList.Fields.KTR_Location, ConditionOperator.Equal, (int)location)
                });

            var managedLists = service.RetrieveMultiple(query).Entities
                .Select(e => e.ToEntity<KTR_ManagedList>())
                .ToList();

            return managedLists;
        }

        public List<KTR_ManagedList> GetByProjectId(Guid projectId, string[] columns = null)
        {
            if (projectId == Guid.Empty)
            {
                return new List<KTR_ManagedList>();
            }

            columns = columns == null || columns.Length == 0
                ? new string[]
                {
                    KTR_ManagedList.Fields.KTR_ManagedListId,
                    KTR_ManagedList.Fields.KTR_Name,
                    KTR_ManagedList.Fields.KTR_Description,
                    KTR_ManagedList.Fields.KTR_IsAutoGenerated
                }
                : columns;

            var query = new QueryExpression(KTR_ManagedList.EntityLogicalName)
            {
                ColumnSet = new ColumnSet(columns),
                Criteria = new FilterExpression
                {
                    Conditions =
                    {
                        new ConditionExpression(KTR_ManagedList.Fields.KTR_Project, ConditionOperator.Equal, projectId),
                        new ConditionExpression(KTR_ManagedList.Fields.StateCode, ConditionOperator.Equal, (int)KTR_ManagedList_StateCode.Active)
                    }
                },
                NoLock = true
            };

            var results = _service.RetrieveMultiple(query);
            return results.Entities.Select(e => e.ToEntity<KTR_ManagedList>()).ToList();
        }

        public int GetQuestionUsageCount(Guid managedListId, Guid projectId)
        {
            if (managedListId == Guid.Empty || projectId == Guid.Empty)
            {
                return 0;
            }

            var qe = new QueryExpression(KTR_QuestionnaireLinesHaRedList.EntityLogicalName)
            {
                ColumnSet = new ColumnSet(false),
                Criteria = new FilterExpression
                {
                    Conditions =
                    {
                        new ConditionExpression(KTR_QuestionnaireLinesHaRedList.Fields.KTR_ManagedList, ConditionOperator.Equal, managedListId),
                        new ConditionExpression(KTR_QuestionnaireLinesHaRedList.Fields.KTR_ProjectId, ConditionOperator.Equal, projectId),
                        new ConditionExpression(KTR_QuestionnaireLinesHaRedList.Fields.StateCode, ConditionOperator.Equal, (int)KTR_QuestionnaireLinesHaRedList_StateCode.Active)
                    }
                },
                NoLock = true
            };

            return _service.RetrieveMultiple(qe).Entities.Count;
        }
    }
}
