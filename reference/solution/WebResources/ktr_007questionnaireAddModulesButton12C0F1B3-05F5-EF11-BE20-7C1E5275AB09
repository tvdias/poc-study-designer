let Sdk = window.Sdk || {};

/**
 * Request to execute a create operation
 */
Sdk.CreateRequest = class {
  constructor(entityName, payload) {
    this.etn = entityName;
    this.payload = payload;
  }
  getMetadata() {
    return {
      boundParameter: null,
      parameterTypes: {},
      operationType: 2, // This is a CRUD operation. Use '0' for actions and '1' for functions
      operationName: "Create",
    };
  }
};

var questionnaireAddModulesButton = (function (config) {
  const lookupTableName = config.lookupTableName;
  const tableQuestionProperties = config.tableQuestionProperties;

  function main(primaryControl) {
    console.log("main");
    const formContext = primaryControl;
    const questionnaireId = formContext.data.entity
      .getId()
      .replace(/[{}]/g, "");
    refreshGrid();
    openSearchDialog()
      .then(async function (selectedModuleRecords) {
        console.log("selectedModuleRecords: ", selectedModuleRecords);
        let entities = await retrieveRecords(selectedModuleRecords);
        return entities;
      })
      .then(async function (entities) {
        console.log("questions: ", entities);
        await copyQuestions(entities, questionnaireId);
      })
      .then(function () {
        refreshGrid();
      })
      .catch(function (error) {
        Xrm.Navigation.openAlertDialog({
          text: "Error: " + error.message,
        });
      });
  }

  function openSearchDialog() {
    // Filter to show only modules that are not already associated
    let lookupOptions = {
      defaultEntityType: lookupTableName,
      entityTypes: [lookupTableName],
      allowMultiSelect: true,
    };

    return Xrm.Utility.lookupObjects(lookupOptions);
  }

  async function retrieveRecords(selectedModuleRecords) {
    const moduleIdFilter = selectedModuleRecords
      .map((module) => `_ktr_module_value eq ${module.id.replace(/[{}]/g, "")}`)
      .join(" or ");

    const query = `?$filter=${encodeURIComponent(moduleIdFilter)}
    &$select=ktr_name,_ktr_module_value
    &$expand=ktr_QuestionBank($select=${Object.values(
      tableQuestionProperties
    ).join(",")})`;

    return Xrm.WebApi.online
      .retrieveMultipleRecords("ktr_modulequestionbank", query)
      .then(function (response) {
        console.log("Questions", response);
        console.log("Entities", response.entities[0]._ktr_module_value);
        let duplicates = validDuplicates(response.entities);

        if (duplicates.length > 0) {
          throw new Error( // improve the error message (MODULE NAME + DUPLICATED QUESTIONS)
            `Duplicated questions found: ${duplicates
              .map((d) => d.ktr_QuestionBank.kt_questiontitle)
              .join(", ")}`
          );
        }

        return response.entities;
      });
  }

  async function copyQuestions(entities, questionnaireId) {
    let createRequests = entities.map((record) => {
      return new Sdk.CreateRequest("kt_questionnairelines", {
        ["ktr_Module@odata.bind"]:
          "/kt_modules(" + record._ktr_module_value + ")",
        statecode: record.ktr_QuestionBank.statecode,
        kt_standardorcustom: record.ktr_QuestionBank.kt_standardorcustom,
        kt_questionvariablename: record.ktr_QuestionBank.kt_name,
        kt_questiontitle: record.ktr_QuestionBank.kt_questiontitle,
        kt_questiontype: record.ktr_QuestionBank.kt_questiontype,
        ktr_questionversion: record.ktr_QuestionBank.kt_questionversion,
        kt_questiontext2: record.ktr_QuestionBank.kt_defaultquestiontext,
        ktr_answerlist: record.ktr_QuestionBank.ktr_answerlist,
        ["kt_Questionnaire@odata.bind"]:
          "/kt_questionnaires(" + questionnaireId + ")",
        ktr_questionrationale: record.ktr_QuestionBank.kt_questionrationale,
        kt_scriptornotes: record.ktr_QuestionBank.kt_scriptornotes,
      });
    });

    return Xrm.WebApi.online
      .executeMultiple(createRequests)
      .then(function (response) {
        console.log("response", response);
      })
      .catch(function (error) {
        Xrm.Navigation.openAlertDialog({
          text: "Error creating: " + error.message,
        });
      });
  }

  function validDuplicates(arr) {
    const seen = new Map();
    const duplicates = [];
    arr.forEach((obj) => {
      const key = obj.ktr_QuestionBank.kt_questionbankid;

      if (seen.has(key)) {
        if (!seen.get(key).isDuplicate) {
          duplicates.push(seen.get(key).object);
          seen.get(key).isDuplicate = true;
        }
        duplicates.push(obj);
      } else {
        seen.set(key, { object: obj, isDuplicate: false,  });
      }
    });

    return duplicates;
  }

  function refreshGrid() {
    let subgridControl = Xrm.Page.getControl("questionnaire_questions_subgrid");
    if (subgridControl) {
      subgridControl.refresh();
    } else {
      console.error("Subgrid not found on the form.");
    }
  }

  return {
    main: main,
  };
})({
  lookupTableName: "kt_module",
  tableQuestionProperties: {
    statecode: "statecode",
    statuscode: "statuscode",
    questionversion: "kt_questionversion",
    questiontype: "kt_questiontype",
    defaultquestiontext: "kt_defaultquestiontext",
    answerlist: "ktr_answerlist",
    questionrationale: "kt_questionrationale",
    standardorcustom: "kt_standardorcustom",
    questiontitle: "kt_questiontitle",
    scriptornotes: "kt_scriptornotes",
    singleormulticode: "kt_singleormulticode",
    methodology: "kt_methodology",
    name: "kt_name",
  },
});
