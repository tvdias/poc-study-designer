/**
 * @file        032-fieldworkLanguagesOnLoad.js
 * @description Executes on form load
 *
 * @date        2025-07-11
 * @version     1.1
 *
 * @usage       This script is invoked on load of the Fieldwork Language Main form
 * @notes       
 */

const Draft = 1; // Your status reason value

function onLoad(executionContext) {
    getRelatedStudyStatus(executionContext);
}

function getRelatedStudyStatus(executionContext) {

    var formContext = executionContext.getFormContext();
    var studyId = formContext.getAttribute("ktr_study").getValue();
    
    // Remove curly braces from the ID
    var cleanId = studyId[0].id.replace(/[{}]/g, "");
    
    // Fetch the related Study record to get its status
    Xrm.WebApi.retrieveRecord("kt_study", cleanId, "?$select=statuscode").then(
        function success(result) {
            var statusCode = result.statuscode;
            if (statusCode !== Draft) {
                lockFormFields(executionContext);
            }
        },
        function (error) {
            console.log("Error retrieving Study status: " + error.message);
        }
    );
}

function lockFormFields(executionContext) {
    var formContext = executionContext.getFormContext();
    
    // Disable all fields on the form
    formContext.ui.controls.forEach(function(control) {
            control.setDisabled(true);

    });
}

