/**
 * @file        018-toggleAnswersFieldAndSubgrid.js
 * @description Toggle Answer fields or subgrid in DependencyRule form based on ConfigurationQuestion Rule (If SingleCoded then field is shown, if MultiCoded then subgrid is shown)
 *
 * @date        2025-04-04
 * @version     1.0
 *
 * @usage       This script is invoked on load of the DependencyRule Main form
 * @notes       
 */
var toggleAnswerFields = (function (config) {
    
    const configQuestionTable = config.configQuestionTable;
    const singleCoded = config.singleCoded;
    const multiCoded = config.multiCoded;

    function init(executionContext, entityForm) {
        var formContext = executionContext.getFormContext();

        var configQuestionField = config[entityForm].configQuestionField;
        var answerField = config[entityForm].answerField;
        var subgrid = config[entityForm].subgrid;

        var configQuestionRef = formContext.getAttribute(configQuestionField).getValue();
        if (!configQuestionRef || configQuestionRef.length === 0) {
            return;
        }

        var configQuestionId = configQuestionRef[0].id.replace(/[{}]/g, "");

        Xrm.WebApi.retrieveRecord(configQuestionTable, configQuestionId, "?$select=ktr_rule")
            .then(function (result) {
                var configQuestionRule = result.ktr_rule;
                
                switch(configQuestionRule) {
                    case singleCoded:
                        formContext.getControl(answerField).setVisible(true);
                        formContext.getControl(subgrid).setVisible(false);
                        break;
                    case multiCoded:
                        formContext.getControl(answerField).setVisible(false);
                        formContext.getControl(subgrid).setVisible(true);
                        break;
                    default:
                        break;
                }
                
            })
            .catch(function (error) {
                console.log("Error retrieving ConfigurationQuestion: " + error.message);
            });
    }

    return {
        init: init,
    };
})({
    dependencyRuleForm: {
        configQuestionField: "ktr_configurationquestion",
        answerField: "ktr_triggeringanswer",
        subgrid: "Answers_subgrid",
    },
    projectConfigQuestionForm: {
        configQuestionField: "ktr_configurationquestion",
        answerField: "ktr_configurationanswer",
        subgrid: "Answers_subgrid_projects",
    },
    configQuestionTable: "ktr_configurationquestion",
    singleCoded: 847610000,
    multiCoded: 847610001,
});
