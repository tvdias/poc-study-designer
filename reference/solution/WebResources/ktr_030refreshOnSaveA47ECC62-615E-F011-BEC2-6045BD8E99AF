/**
 * @file        030-StudyRefreshOnSave.js
 * @description Refreshes the Study form post save
 *
 * @date        2025-07-11
 * @version     1.2
 *
 * @usage       This script is invoked on save of the Main form of Study entity
 *              This is supposed to refresh the study form post the record is saved so that user can see the 
 *                  FWLanguages cleared out when the Fieldwork Market lookup in Study is updated.
 * @notes       
 */

var StudyRefreshOnSave = (function (config) {

    const LanguagesSubgrid = config.LanguagesSubgrid;
    const DraftStatusReason = config.DraftStatusReason;

    async function onSave(executionContext) {
        var formContext = executionContext.getFormContext();
        const eventArgs = executionContext.getEventArgs();

        // Check if Study is DRAFT
        const statusReason = formContext.getAttribute("statuscode")?.getValue();
        if (statusReason !== DraftStatusReason) {
            console.log("Study is not in DRAFT — skipping API call.");
            return;
        }

        const projectId = formContext.getAttribute("kt_project")?.getValue();
        if (!projectId || projectId.length === 0) {
            console.warn("ProjectId empty — skipping API call.");
            return;
        }

        // Stop the save → we want API FIRST
        eventArgs.preventDefault();

        try {
            const projectGuid = projectId[0].id.replace(/[{}]/g, "");

            const response = await callRegenerateHTMLCustomAPI(projectGuid);
            if (!response.ok) {
                console.error("Custom API returned an error:", response);
                return;
            }

            console.log("Custom API completed successfully.");

            // Now continue the save
            await formContext.data.save();
        } catch (error) {
            console.error("Custom API execution failed:", error);
            return; // Do NOT save if API fails
        }

        // Post-save subgrid refresh
        setTimeout(function () {
            formContext.getControl(LanguagesSubgrid).refresh();
        }, 3000);
    }

    function callRegenerateHTMLCustomAPI(projectId) {
        var request = {
            projectId: projectId,
            getMetadata: function () {
                return {
                    boundParameter: null,
                    parameterTypes: {
                        projectId: {
                            typeName: "Edm.String",
                            structuralProperty: 1
                        }
                    },
                    operationType: 0,
                    operationName: "ktr_project_questionnairelines_regenerate_html_unbound"
                };
            }
        };

        return Xrm.WebApi.online.execute(request);
    }

    return {
        onSave: onSave,
    };
})({
   LanguagesSubgrid: 'Subgrid_new_6',
   DraftStatusReason: 1
});