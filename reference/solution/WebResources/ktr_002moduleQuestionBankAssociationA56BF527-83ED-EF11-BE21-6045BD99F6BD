/**
 * @file        moduleQuestionBankAssociation.js
 * @description Opens a Search Dialog of entity 'QuestionBank' and allows user to select records and add them to Module.
 *              
 * @date        2025-02-14
 * @version     1.0
 * 
 * @usage       This script is being called when Adding Questions inside a Module form (in edit-mode)
 * @notes       This script uses Xrm Power Apps library
*/

var SearchQuestionBankModuleAssociation = (function (config) {
  
  const lookupTableName = config.lookupTableName;
  const finalTableName = config.finalTableName;
  const gridId = config.gridId;

  function openSearchDialog() {
    var lookupOptions = {
      defaultEntityType: lookupTableName,
      entityTypes: [lookupTableName],
      allowMultiSelect: true,
    };

    Xrm.Utility.lookupObjects(lookupOptions).then(
      function (success) {
        if (success.length === 0) {
          return;
        }

        var moduleId = getModuleId();

        if (!moduleId) {
          Xrm.Navigation.openAlertDialog({
            text: "Error: Unable to retrieve the Module ID.",
          });
          return;
        }

        const retrievePromises = success.map((selectedRecord) =>
          createModuleQuestionBankRecord(selectedRecord.id, moduleId)
        );

        Promise.allSettled(retrievePromises).then((results) => {
          const hasAnySuccess = results.some(
            (result) => result.status === "fulfilled"
          );

          if (hasAnySuccess) {
            Xrm.Navigation.openAlertDialog({
              text: "Records added successfully!",
            });
          } else {
            Xrm.Navigation.openErrorDialog({
              message: "Records could not be added.",
            });
          }

          refreshGrid();
        });
      },
      function (error) {
        console.error("Error opening lookup:", error);
      }
    );
  }

  function createModuleQuestionBankRecord(recordId, moduleId) {
    return retrieveQuestionBankRecord(recordId).then((record) =>
      createModuleQuestionBankEntry(record, moduleId)
    );
  }

  function getModuleId() {
    if (Xrm.Page && Xrm.Page.data && Xrm.Page.data.entity) {
      return Xrm.Page.data.entity.getId().replace(/[{}]/g, "");
    } else if (Xrm.Utility.getPageContext) {
      return Xrm.Utility.getPageContext().input.entityId.replace(/[{}]/g, "");
    }
    return null;
  }

  function retrieveQuestionBankRecord(recordId) {
    return Xrm.WebApi.retrieveRecord(
      lookupTableName,
      recordId.replace(/[{}]/g, ""),
      "?$select=kt_name"
    );
  }

  function refreshGrid() {
    var subgridControl = Xrm.Page.getControl(gridId);
    if (subgridControl) {
      subgridControl.refresh();
    } else {
      console.error("Subgrid not found on the form.");
    }
  }

  function createModuleQuestionBankEntry(questionBankRecord, moduleId) {
    const newRecord = {
      ["ktr_Module@odata.bind"]: "/kt_modules(" + moduleId + ")",
      "ktr_name": questionBankRecord.kt_name,
      ["ktr_QuestionBank@odata.bind"]: "/kt_questionbanks(" + questionBankRecord.kt_questionbankid + ")"
    };

    var result =  Xrm.WebApi.createRecord(finalTableName, newRecord).then(
      (result) => {
        console.log("Module Question Bank record created with ID:", result.id);
      }
    );

    console.log(result);

    return result;
  }

  return {
    openSearchDialog: openSearchDialog,
  };
})({
  lookupTableName: 'kt_questionbank',
  finalTableName: 'ktr_modulequestionbank',
  gridId: 'Subgrid_Module_Questions',
});