
/**
 * @file        026-CreateWithAI.js
 * @description To create front door for AI 
 *
 * @date        2025-06-23
 * @version     1.0
 *
 * @usage       This script is invoked on load and save of the Create With AI button and its form on Project entity.
 * @notes       
 */
if (typeof (KTR) === "undefined") {
    "use strict";
    KTR = {
        __namespace: true
    };
}

KTR.Project = {
    client: 'ktr_clientaccount',
    commissioningmarket: 'kt_commissioningmarket',
    product: 'ktr_product',
    producttemplate: 'ktr_producttemplate',
    aiFormId: '3079cc3f-274c-f011-877a-6045bd9637eb',
    aiURL: 'ktr_AIFrontDoorBaseURL',

    /**
     * To open the Create with AI Main form in Project
     */
    openFormPop: function () {
        "use strict";

        var entityFormOptions = {};
        entityFormOptions["entityName"] = "kt_project";
        entityFormOptions["formId"] = this.aiFormId;


        Xrm.Navigation.openForm(entityFormOptions).then(
            function (success) {

            },
            function (error) {
                console.log("Error opening form: " + error.message);
            }
        );
    },
    /**
     * 
     * @param {*} primaryControl 
     * On the click of Submit button it will open the AI in a new tab
     */
    redirectToAIFrontDoor: function (primaryControl) {
        "use strict";
        var formContext = primaryControl
        var clientID = this.fetchID(formContext, this.client);
        var productID = this.fetchID(formContext, this.product);
        var comissioning_market_id = this.fetchID(formContext, this.commissioningmarket);
        var productTemplateID = this.fetchID(formContext, this.producttemplate);
        
        // Get client name and commissioning market name
        var clientName = this.fetchName(formContext, this.client);
        var commissioningMarketName = this.fetchName(formContext, this.commissioningmarket);
        
        Xrm.WebApi.retrieveMultipleRecords('environmentvariablevalue', `?$select=value&$expand=EnvironmentVariableDefinitionId&$filter=(EnvironmentVariableDefinitionId/schemaname eq '${this.aiURL}')`).then(
            function success(result) {
                if(result.entities.length > 0){
                var value = result.entities[0].value;
                var url = value + "/?product_id=" + productID + "&product_template_id=" + productTemplateID + "&client_id=" + clientID + "&client_name=" + encodeURIComponent(clientName) + "&comissioning_market_id=" + comissioning_market_id + "&commissioning_market_name=" + encodeURIComponent(commissioningMarketName);
                var newTab = window.open(url, '_blank');
                newTab.focus();}
                else{
                    Xrm.Navigation.openErrorDialog({ message: 'AI base URL not found.' });
                    }
                
            },
            function (error) {
                Xrm.Navigation.openErrorDialog({ details: error.message, message: 'A problem occurred while retrieving an Environment Variable value. Please contact support.' });
            }
        );
        this.closeButton(formContext);
    },
    /**
     * 
     * @param {*} formContext 
     * @param {*} column 
     * @returns id
     * To fetch the value id of the attribute passed
     */
    fetchID: function (formContext, column) {
        var id = formContext.getAttribute(column).getValue()[0].id;
        id = id.replace("{", "").replace("}", "");
        return id

    },
    
    /**
     * 
     * @param {*} formContext 
     * @param {*} column 
     * @returns name
     * To fetch the display name of the lookup attribute passed
     */
    fetchName: function (formContext, column) {
        var name = formContext.getAttribute(column).getValue()[0].name;
        return name;
    },
    /**
     * 
     * @param {*} primaryControl 
     * @returns boolean
     * to Set the visibility of the Submit button only on the CreateWithAI form
     */
    setSubmitVisibility: function (primaryControl) {
        "use strict";

        var formContext = primaryControl;

        var formId = formContext.ui.formSelector.getCurrentItem().getId();
        var clientID = formContext.getAttribute(this.client).getValue();
        var productID = formContext.getAttribute(this.product).getValue();
        var productTemplateID = formContext.getAttribute(this.producttemplate).getValue();
        var comissioning_market_id = formContext.getAttribute(this.commissioningmarket).getValue();
        return (clientID != null && clientID !== "" && productID != null && productID !== "" && productTemplateID != null && productTemplateID !== "" && comissioning_market_id != null && comissioning_market_id !== "" && formId == this.aiFormId) 
      
    },

    /**
     * 
     * @param {*} primaryControl 
     * @returns boolean
     * To Hide the unwanted buttons from the CreateWithAI form
     */
    setButtonVisibility: function (primaryControl) {
        var formContext = primaryControl;
        var formId = formContext.ui.formSelector.getCurrentItem().getId();
      
        return !(formId === this.aiFormId)
    },
    /**
     * 
     * @param {*} executionContext 
     * To refresh the Ribbon button to show or hide the submit button
     */

    refreshButton: function (executionContext) {
        var formContext = executionContext.getFormContext();
        formContext.ui.refreshRibbon()
    },
    /**
     * 
     * @param {*} primaryControl 
     * On the click on Cancel button the form should close
     */
    closeButton: function (primaryControl) {

        if (primaryControl.data.entity.getIsDirty()) {
            // Setting fields null to close the form  (no prompt)

            primaryControl.getAttribute(this.client).setValue(null);
            primaryControl.getAttribute(this.product).setValue(null);
            primaryControl.getAttribute(this.producttemplate).setValue(null);
            primaryControl.getAttribute(this.commissioningmarket).setValue(null);

        }
        primaryControl.ui.close();

    }
}

