name: CI Quality Gate

# This workflow runs comprehensive checks on pull requests including:
# - Backend unit and integration tests
# - Frontend tests with coverage enforcement (80% threshold)
# Separate from backend-ci.yml and frontend-ci.yml which run on push for quick feedback.
# This prevents duplicate test execution: PRs use this workflow, pushes use the CI workflows.

on:
  pull_request:
    branches: [ main, develop ]

jobs:
  backend-tests:
    runs-on: ubuntu-latest
    name: Backend Tests
    
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: '10.0.x'

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'

      - name: Restore dependencies
        run: dotnet restore src/StudyDesigner.slnx

      - name: Build solution
        run: dotnet build src/StudyDesigner.slnx --no-restore --configuration Release

      - name: Run unit tests
        run: dotnet run --project src/Api.Tests/Api.Tests.csproj --no-build --configuration Release -- --coverage --coverage-output-format Cobertura

      - name: Install ReportGenerator
        run: dotnet tool install -g dotnet-reportgenerator-globaltool

      - name: Generate Coverage Report
        run: |
          reportgenerator -reports:"**/TestResults/**/*.cobertura.xml" -targetdir:"coverage" -reporttypes:"Cobertura;JsonSummary"

      - name: Check Backend Coverage Threshold (80%)
        run: |
          if [ ! -f coverage/Summary.json ]; then
            echo "‚ùå Coverage summary not found"
            exit 1
          fi

          # Extract coverage percentage for lines (can also check branches, etc.)
          COVERAGE=$(cat coverage/Summary.json | jq -r '.summary.linecoverage')
          
          echo "üìä Backend Coverage Results:"
          echo "  Line Coverage: ${COVERAGE}%"
          
          if (( $(echo "$COVERAGE < 80" | bc -l) )); then
            echo "‚ùå Backend line coverage ${COVERAGE}% is below threshold of 80%"
            exit 1
          fi

          echo "‚úÖ Backend coverage threshold met (‚â•80%)"

      - name: Publish Coverage Report to PR
        if: always()
        uses: madrapps/cobertura-action@v1
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          path: coverage/Cobertura.xml
          minimum_coverage: 80
          fail_below_threshold: false # We handle failure in the previous step for custom messaging, or set true here.
          show_missing: true

      - name: Run integration tests
        run: dotnet run --project src/Api.IntegrationTests/Api.IntegrationTests.csproj --no-build --configuration Release

      - name: Install Playwright Browsers
        run: playwright install --with-deps

      - name: Install Admin App Dependencies
        working-directory: src/Admin
        run: npm ci

      - name: Install Designer App Dependencies
        working-directory: src/Designer
        run: npm ci

      - name: Run E2E tests
        run: dotnet run --project src/Api.E2ETests/Api.E2ETests.csproj --no-build --configuration Release

  frontend-coverage:
    runs-on: ubuntu-latest
    name: Frontend Tests & Coverage
    permissions:
      pull-requests: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: src/Admin/package-lock.json

      - name: Install dependencies
        working-directory: src/Admin
        run: npm ci

      - name: Install Vitest Coverage Provider
        working-directory: src/Admin
        run: npm install --save-dev @vitest/coverage-v8

      - name: Run tests with coverage
        working-directory: src/Admin
        run: npm run test -- --coverage --run --reporter=verbose

      - name: Check Frontend Coverage Threshold (50%)
        working-directory: src/Admin
        run: |
          # Parse coverage from the summary
          if [ -f coverage/coverage-summary.json ]; then
            LINES=$(cat coverage/coverage-summary.json | jq -r '.total.lines.pct')
            BRANCHES=$(cat coverage/coverage-summary.json | jq -r '.total.branches.pct')
            FUNCTIONS=$(cat coverage/coverage-summary.json | jq -r '.total.functions.pct')
            STATEMENTS=$(cat coverage/coverage-summary.json | jq -r '.total.statements.pct')
            
            echo "üìä Coverage Results:"
            echo "  Lines: ${LINES}%"
            echo "  Branches: ${BRANCHES}%"
            echo "  Functions: ${FUNCTIONS}%"
            echo "  Statements: ${STATEMENTS}%"
            
            FAILED=0
            if (( $(echo "$LINES < 50" | bc -l) )); then
              echo "‚ùå Line coverage ${LINES}% is below threshold of 50%"
              FAILED=1
            fi
            if (( $(echo "$BRANCHES < 50" | bc -l) )); then
              echo "‚ùå Branch coverage ${BRANCHES}% is below threshold of 50%"
              FAILED=1
            fi
            if (( $(echo "$FUNCTIONS < 50" | bc -l) )); then
              echo "‚ùå Function coverage ${FUNCTIONS}% is below threshold of 50%"
              FAILED=1
            fi
            if (( $(echo "$STATEMENTS < 50" | bc -l) )); then
              echo "‚ùå Statement coverage ${STATEMENTS}% is below threshold of 50%"
              FAILED=1
            fi
            
            if [ $FAILED -eq 1 ]; then
              exit 1
            else
              echo "‚úÖ All coverage thresholds met (‚â•50%)"
            fi
          else
            echo "‚ùå Coverage summary not found"
            exit 1
          fi

      - name: Generate Coverage Report for PR
        if: always()
        uses: davelosert/vitest-coverage-report-action@v2
        with:
          working-directory: src/Admin

  quality-gate:
    runs-on: ubuntu-latest
    name: Quality Gate Status
    needs: [backend-tests, frontend-coverage]
    if: always()
    
    steps:
      - name: Check Quality Gate
        run: |
          echo "Backend Tests: ${{ needs.backend-tests.result }}"
          echo "Frontend Coverage: ${{ needs.frontend-coverage.result }}"
          
          if [ "${{ needs.backend-tests.result }}" != "success" ]; then
            echo "‚ùå Quality gate failed: Backend tests failed"
            exit 1
          fi
          
          if [ "${{ needs.frontend-coverage.result }}" != "success" ]; then
            echo "‚ùå Quality gate failed: Frontend coverage threshold not met (required: 80%)"
            exit 1
          fi
          
          echo "‚úÖ Quality gate passed: All tests passed and coverage ‚â•80%"
